<?xml version="1.0" encoding="UTF-8"?>

<?ifndef Version?>
<?define Version = "0.4.3" ?>
<?endif ?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="{DA805477-316E-4344-96EF-180BD76854F0}" 
           Name="Open Source Automation - Server x64" 
           Language="1033" Version="$(var.Version)" 
           Manufacturer="Open Source Automation" 
           UpgradeCode="1c604626-1e6c-4bf9-83a3-1010f65a7c83">
    
    <Package Id='*' InstallerVersion="200" Comments='Version $(var.Version) of Open Source Automation Server' Compressed="yes" Platform="x64" InstallScope="perMachine" />
    
    <!--<Upgrade Id="1c604626-1e6c-4bf9-83a3-1010f65a7c83">
      <UpgradeVersion OnlyDetect='no' Property='PREVIOUSFOUND' Minimum='0.1.0' IncludeMinimum='yes' Maximum='$(var.Version)' IncludeMaximum='no' />
    </Upgrade>-->  

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" CompressionLevel="high"  />
    <Binary Id="CustomActionsBinary" SourceFile="$(var.SolutionDir)CustomActions\bin\x86\Combined\OSAInstallCustomActions.CA.dll" />
    
    <Feature Id="ProductFeature" Title="OSA Server" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="group_WebServer" />
      <MergeRef Id='Core' />
      <MergeRef Id='Screens' />
      <MergeRef Id='Plugins' />
      <MergeRef Id='ServerMergeModule' />
    </Feature>   
    
    <CustomAction Id="DBUpdateCustomAction"                 
                  BinaryKey="CustomActionsBinary"
                  DllEntry="Server"
                  Execute="deferred"
                  Return="check" />
    
    <InstallExecuteSequence>
      <!--<RemoveExistingProducts After='InstallFinalize'/>-->
      <Custom Action="DBUpdateCustomAction" Before="InstallFinalize">
        NOT Installed
      </Custom>
    </InstallExecuteSequence>
  </Product>
  
  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="INSTALLFOLDER" Name="INSTALLLOCATION" >
        <Merge Id='ServerMergeModule' Language='1033' src='$(var.SolutionDir)MergeModules\Server\bin\x86\Combined\server.msm' DiskId='1' />
        <Merge Id='Screens' Language='1033' src='$(var.SolutionDir)MergeModules\Screens\bin\Release\Screens.msm' DiskId='1' />
        <Merge Id='Core' Language='1033' src='$(var.SolutionDir)MergeModules\Core\bin\Release\Core.msm' DiskId='1' />
        <Directory Id="PluginsFolder" Name="Plugins" >
          <Merge Id='Plugins' Language='1033' src='$(var.SolutionDir)MergeModules\Plugins\bin\x86\Combined\Plugins.msm' DiskId='1' />         
        </Directory>
      </Directory>
    </Directory>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
    </ComponentGroup>
  </Fragment>
</Wix>

